<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Evaluations — Royal Vending</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    /* Modal + UI helpers */
    .modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#fff; padding:18px; border-radius:8px; width:720px; max-height:88vh; overflow:auto; box-shadow:0 6px 24px rgba(0,0,0,0.2); }
    .filter-bar { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .skill-row { margin-bottom:10px; border-bottom:1px dashed #eee; padding-bottom:6px; }
    .skill-row strong { display:block; margin-bottom:6px; }
    .notes { width:100%; min-height:40px; display:none; margin-top:6px; }
    .table-actions button { margin-right:6px; }
    .flex-row { display:flex; gap:8px; align-items:center; }
    .small-input { width:200px; }
    .manage-skills { border:1px solid #eee; padding:8px; margin-top:8px; }
    .btn { padding:6px 10px; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>

<header>
  <img src="assets/images/logo.png" class="logo" alt="Royal Vending">
  <nav>
    <a href="dashboard.html">Dashboard</a>
    <a href="evaluations.html" class="active">Evaluations</a>
    <a href="coaching.html">Coaching Logs</a>
    <a href="reports.html">Reports</a>
    <a href="admin.html">Admin</a>
    <button id="logoutBtn" class="btn">Logout</button>
  </nav>
</header>

<main>
  <h1>Evaluations</h1>

  <!-- FILTER BAR -->
  <div class="filter-bar">
    <select id="filterMember"><option value="">Team Member</option></select>

    <select id="filterDept">
      <option value="">Department</option>
      <option value="Account Manager">Account Manager</option>
      <option value="Technical Support">Technical Support</option>
      <option value="Transport">Transport</option>
      <option value="Inventory">Inventory</option>
    </select>

    <select id="filterMonth"><option value="">Month</option></select>

    <select id="filterEvaluator"><option value="">Evaluator</option></select>

    <select id="filterScore">
      <option value="">Score Range</option>
      <option value="90-100">90 - 100</option>
      <option value="80-89">80 - 89</option>
      <option value="70-79">70 - 79</option>
      <option value="0-69">Below 70</option>
    </select>

    <input id="filterSearch" placeholder="Search..." />

    <button id="applyFilters" class="btn">Search</button>

    <div style="margin-left:auto">
      <button id="openEvalModal" class="btn">+ Add New Evaluation</button>
    </div>
  </div>

  <!-- TABLE -->
  <table id="evalTable" border="1" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th>Team Member</th>
        <th>Dept</th>
        <th>Evaluator</th>
        <th>Date</th>
        <th>% Score</th>
        <th>✔</th>
        <th>❌</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<!-- ADD / CREATE EVALUATION MODAL -->
<div class="modal-bg" id="evalModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="evalModalTitle">
    <h3 id="evalModalTitle">Add New Evaluation</h3>

    <div class="flex-row" style="gap:12px; margin-bottom:8px;">
      <label style="min-width:90px">Date:</label>
      <input type="date" id="evDate" />

      <label style="min-width:90px; margin-left:12px">Department:</label>
      <select id="evDept">
        <option value="Account Manager">Account Manager</option>
        <option value="Technical Support">Technical Support</option>
        <option value="Transport">Transport</option>
        <option value="Inventory">Inventory</option>
      </select>
    </div>

    <div style="display:flex; gap:12px; margin-bottom:8px;">
      <div>
        <label>Team Member</label><br>
        <select id="evMember" class="small-input"></select>
      </div>

      <div>
        <label>Evaluator</label><br>
        <select id="evEvaluator" class="small-input"></select>
      </div>
    </div>

    <div style="margin-bottom:8px;">
      <label>Call ID / Email Link</label>
      <input type="text" id="evCallId" placeholder="Call ID or URL" style="width:62%;" />
    </div>

    <div style="margin-bottom:8px;">
      <label>Summary</label>
      <textarea id="evSummary" placeholder="Short summary" style="width:100%; min-height:50px"></textarea>
    </div>

    <div style="display:flex; gap:12px; align-items:center;">
      <h4 style="margin:0">Skills</h4>
      <button id="editSkillsBtn" class="btn" title="Add or Save skills for this department">Manage Skills</button>
    </div>

    <div id="skillsContainer" style="margin-top:8px;"></div>

    <div class="manage-skills" id="manageSkills" style="display:none;">
      <label>Existing skills for department:</label>
      <ul id="existingSkills"></ul>

      <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
        <input id="newSkillInput" placeholder="New skill name" />
        <button id="addSkillBtn" class="btn">Add</button>
        <button id="saveSkillsBtn" class="btn">Save to Department</button>
      </div>
    </div>

    <div style="margin-top:8px;">
      <label>Total Score</label>
      <input id="evTotal" readonly />
    </div>

    <div style="margin-top:8px;">
      <label>Comments / Notes</label>
      <textarea id="evNotes" placeholder="Additional notes" style="width:100%; min-height:50px"></textarea>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="submitEval" class="btn">Submit</button>
      <button id="closeEvalModal" class="btn">Cancel</button>
    </div>
  </div>
</div>

<!-- VIEW MODAL -->
<div class="modal-bg" id="viewModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Evaluation Details</h3>
    <div id="viewContent"></div>
    <div style="margin-top:10px; display:flex; gap:8px;">
      <button id="closeView" class="btn">Close</button>
      <button id="openEditFromView" class="btn">Edit</button>
      <button id="deleteFromView" class="btn" style="background:#ffdddd; color:#900">Delete</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-bg" id="editModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Edit Evaluation</h3>
    <input type="hidden" id="editId" />

    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <div>
        <label>Date</label><br><input type="date" id="editDate" />
      </div>
      <div>
        <label>Department</label><br>
        <select id="editDept">
          <option>Account Manager</option>
          <option>Technical Support</option>
          <option>Transport</option>
          <option>Inventory</option>
        </select>
      </div>
    </div>

    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <div>
        <label>Team Member</label><br><select id="editMember"></select>
      </div>
      <div>
        <label>Evaluator</label><br><select id="editEvaluator"></select>
      </div>
    </div>

    <div style="margin-bottom:8px;">
      <label>Call ID</label><br><input id="editCallId" />
    </div>

    <div style="margin-bottom:8px;">
      <label>Summary</label><br><textarea id="editSummary"></textarea>
    </div>

    <div id="editSkillsContainer"></div>

    <div style="margin-top:8px;">
      <label>Total</label><br><input id="editTotal" readonly />
    </div>

    <div style="margin-top:8px;">
      <label>Feedback</label><br><textarea id="editFeedback"></textarea>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px;">
      <button id="saveEditBtn" class="btn">Save</button>
      <button id="cancelEditBtn" class="btn">Cancel</button>
    </div>
  </div>
</div>

<!-- SCRIPT: modular firebase + page logic -->
<script type="module">
  // Import helpers exported from your api-firebase.js (which must export db too)
  import {
    listEvaluations,
    addEvaluation,
    adminListAll,
    logoutUser,
    db
  } from './api-firebase.js';

  // Firestore helpers from CDN modular (v10)
  import { doc, setDoc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Session guard
  if (!sessionStorage.getItem('rvc_user')) {
    window.location.href = 'index.html';
  }

  // DOM refs
  const filterMember = document.getElementById('filterMember');
  const filterDept = document.getElementById('filterDept');
  const filterMonth = document.getElementById('filterMonth');
  const filterEvaluator = document.getElementById('filterEvaluator');
  const filterScore = document.getElementById('filterScore');
  const filterSearch = document.getElementById('filterSearch');
  const applyFilters = document.getElementById('applyFilters');

  const openEvalModal = document.getElementById('openEvalModal');
  const evalModal = document.getElementById('evalModal');
  const closeEvalModal = document.getElementById('closeEvalModal');

  const evDate = document.getElementById('evDate');
  const evDept = document.getElementById('evDept');
  const evMember = document.getElementById('evMember');
  const evEvaluator = document.getElementById('evEvaluator');
  const evCallId = document.getElementById('evCallId');
  const evSummary = document.getElementById('evSummary');
  const skillsContainer = document.getElementById('skillsContainer');
  const evTotal = document.getElementById('evTotal');
  const evNotes = document.getElementById('evNotes');
  const submitEval = document.getElementById('submitEval');

  const manageSkills = document.getElementById('manageSkills');
  const editSkillsBtn = document.getElementById('editSkillsBtn');
  const existingSkills = document.getElementById('existingSkills');
  const newSkillInput = document.getElementById('newSkillInput');
  const addSkillBtn = document.getElementById('addSkillBtn');
  const saveSkillsBtn = document.getElementById('saveSkillsBtn');

  const viewModal = document.getElementById('viewModal');
  const viewContent = document.getElementById('viewContent');
  const closeView = document.getElementById('closeView');
  const openEditFromView = document.getElementById('openEditFromView');
  const deleteFromView = document.getElementById('deleteFromView');

  const editModal = document.getElementById('editModal');
  const editId = document.getElementById('editId');
  const editDate = document.getElementById('editDate');
  const editDept = document.getElementById('editDept');
  const editMember = document.getElementById('editMember');
  const editEvaluator = document.getElementById('editEvaluator');
  const editCallId = document.getElementById('editCallId');
  const editSummary = document.getElementById('editSummary');
  const editSkillsContainer = document.getElementById('editSkillsContainer');
  const editTotal = document.getElementById('editTotal');
  const editFeedback = document.getElementById('editFeedback');
  const saveEditBtn = document.getElementById('saveEditBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await logoutUser();
    sessionStorage.removeItem('rvc_user');
    window.location.href = 'index.html';
  });

  // In-memory cache of evaluations
  window._allEvaluations = [];

  // ----- Department skills storage functions -----
  async function loadDepartmentSkills(dept) {
    if (!dept) return [];
    try {
      const ref = doc(db, 'departmentSkills', dept);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        // default fallback lists per department
        const defaults = {
          "Account Manager": ["Communication","Relationship Building","Task Management","Customer Service","Accuracy & Attention to Detail","Analytical & Reporting Skills","Problem-Solving"],
          "Technical Support": ["Communication","Problem-Solving","Task Management","Accuracy & Attention to Detail","Analytical & Reporting Skills","Customer Service","Relationship Building"],
          "Transport": ["Accuracy & Attention to Detail","Task Management","Communication","Customer Service","Relationship Building","Problem-Solving","Analytical & Reporting Skills"],
          "Inventory": ["Accuracy & Attention to Detail","Task Management","Analytical & Reporting Skills","Communication","Problem-Solving","Relationship Building","Customer Service"]
        };
        return defaults[dept] || [];
      } else {
        const data = snap.data();
        return Array.isArray(data.skills) ? data.skills : [];
      }
    } catch (err) {
      console.error('loadDepartmentSkills', err);
      return [];
    }
  }

  async function saveDepartmentSkills(dept, skills) {
    if (!dept) throw new Error('Missing department');
    const ref = doc(db, 'departmentSkills', dept);
    await setDoc(ref, { skills }, { merge: true });
  }

  // ----- Render skills UI -----
  function renderSkillsForContainer(skills, container, prefix='') {
    container.innerHTML = '';
    skills.forEach((s, i) => {
      const name = `${prefix}skill_${i}`;
      const notesId = `${prefix}skill_notes_${i}`;

      const div = document.createElement('div');
      div.className = 'skill-row';
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>${s}</strong>
          <div>
            <label><input type="radio" name="${name}" value="yes"> ✔️</label>
            <label><input type="radio" name="${name}" value="no"> ❌</label>
          </div>
        </div>
        <textarea id="${notesId}" class="notes" placeholder="Reason for ❌"></textarea>
      `;
      container.appendChild(div);

      div.querySelectorAll('input[type="radio"]').forEach(r => {
        r.addEventListener('change', () => {
          const notesEl = document.getElementById(notesId);
          if (r.value === 'no') notesEl.style.display = 'block';
          else { notesEl.style.display = 'none'; notesEl.value = ''; }
          calculateTotalFromContainer(container, prefix);
        });
      });
    });
  }

  function calculateTotalFromContainer(container, prefix='') {
    const rows = Array.from(container.querySelectorAll('.skill-row'));
    let yes = 0;
    rows.forEach((row, i) => {
      const name = `${prefix}skill_${i}`;
      const selected = row.querySelector(`input[name="${name}"]:checked`);
      if (selected && selected.value === 'yes') yes++;
    });
    const percent = rows.length ? (yes / rows.length) * 100 : 0;
    if (prefix === 'edit_') editTotal.value = percent.toFixed(2) + '%';
    else evTotal.value = percent.toFixed(2) + '%';
    return { percent, yes, total: rows.length };
  }

  // ----- Populate filters and dropdowns -----
  async function loadFiltersAndDropdowns() {
    const data = await adminListAll();

    const members = data.members || [];
    filterMember.innerHTML = '<option value="">Team Member</option>';
    evMember.innerHTML = '<option value="">Select</option>';
    editMember.innerHTML = '<option value="">Select</option>';
    members.forEach(m => {
      const name = (m && (m.name || m[0])) || String(m);
      filterMember.innerHTML += `<option value="${name}">${name}</option>`;
      evMember.innerHTML += `<option value="${name}">${name}</option>`;
      editMember.innerHTML += `<option value="${name}">${name}</option>`;
    });

    filterEvaluator.innerHTML = '<option value="">Evaluator</option>';
    evEvaluator.innerHTML = '<option value="">Select</option>';
    editEvaluator.innerHTML = '<option value="">Select</option>';
    (data.users || []).forEach(u => {
      const nm = u.name || u.email || u[0] || '';
      filterEvaluator.innerHTML += `<option value="${nm}">${nm}</option>`;
      evEvaluator.innerHTML += `<option value="${nm}">${nm}</option>`;
      editEvaluator.innerHTML += `<option value="${nm}">${nm}</option>`;
    });
  }

  // ----- Load table -----
  async function loadEvaluations(listOverride = null) {
    const tbody = document.querySelector('#evalTable tbody');
    tbody.innerHTML = '';

    const list = listOverride || await listEvaluations();
    window._allEvaluations = (list || []).map(d => ({ id: d.id || d._id || d._docId || d.docId || null, ...d }));

    (list || []).forEach(r => {
      const skills = r.skills ? Object.values(r.skills) : [];
      const checks = skills.filter(s => s.value === '✔️').length;
      const xes = skills.filter(s => s.value === '❌').length;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.member || ''}</td>
        <td>${r.department || r.dept || ''}</td>
        <td>${r.evaluator || ''}</td>
        <td>${r.date || ''}</td>
        <td>${r.total || ''}</td>
        <td>${checks}</td>
        <td>${xes}</td>
        <td class="table-actions">
          <button class="btn" onclick="viewEval('${r.id || r._id || r.docId || ''}')">View</button>
          <button class="btn" onclick="editEval('${r.id || r._id || r.docId || ''}')">Edit</button>
          <button class="btn" onclick="deleteEval('${r.id || r._id || r.docId || ''}')" style="background:#ffdddd;color:#900">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // months
    const months = Array.from(new Set((list || []).map(x => (x.date || '').slice(0,7)).filter(Boolean))).sort().reverse();
    filterMonth.innerHTML = '<option value="">Month</option>';
    months.forEach(m => filterMonth.innerHTML += `<option value="${m}">${m}</option>`);
  }

  // ----- Filters handler -----
  applyFilters.addEventListener('click', async () => {
    let list = await listEvaluations();
    if (filterMember.value) list = list.filter(e => e.member === filterMember.value);
    if (filterDept.value) list = list.filter(e => (e.department || e.dept) === filterDept.value);
    if (filterMonth.value) list = list.filter(e => (e.date || '').startsWith(filterMonth.value));
    if (filterEvaluator.value) list = list.filter(e => e.evaluator === filterEvaluator.value);
    if (filterScore.value) {
      const [min, max] = filterScore.value.split('-').map(Number);
      list = list.filter(e => {
        const v = parseFloat((e.total || '0').replace('%','')) || 0;
        return v >= min && v <= (max || 100);
      });
    }
    if (filterSearch.value) {
      const q = filterSearch.value.toLowerCase();
      list = list.filter(e => JSON.stringify(e).toLowerCase().includes(q));
    }
    loadEvaluations(list);
  });

  // ----- Skills management UI -----
  editSkillsBtn.addEventListener('click', async () => {
    if (manageSkills.style.display === 'none' || manageSkills.style.display === '') {
      manageSkills.style.display = 'block';
      await refreshExistingSkills();
    } else {
      manageSkills.style.display = 'none';
    }
  });

  addSkillBtn.addEventListener('click', () => {
    const val = newSkillInput.value.trim();
    if (!val) return;
    const li = document.createElement('li');
    li.textContent = val;
    existingSkills.appendChild(li);
    newSkillInput.value = '';
  });

  saveSkillsBtn.addEventListener('click', async () => {
    const dept = evDept.value;
    if (!dept) return alert('Choose department');
    const arr = Array.from(existingSkills.querySelectorAll('li')).map(li => li.textContent.trim()).filter(Boolean);
    await saveDepartmentSkills(dept, arr);
    alert('Skills saved for ' + dept);
    manageSkills.style.display = 'none';
  });

  async function refreshExistingSkills() {
    existingSkills.innerHTML = '';
    const skills = await loadDepartmentSkills(evDept.value);
    skills.forEach(s => {
      const li = document.createElement('li'); li.textContent = s; existingSkills.appendChild(li);
    });
  }

  // when department changes, render skills
  evDept.addEventListener('change', async () => {
    const sk = await loadDepartmentSkills(evDept.value);
    renderSkillsForContainer(sk, skillsContainer);
  });

  // ----- Modal open/close robust handlers -----
  (function attachModalHandlers(){
    // open eval modal
    openEvalModal.addEventListener('click', () => {
      evalModal.style.display = 'flex';
      // render current dept skills on open
      evDept.dispatchEvent(new Event('change'));
    });

    // close eval modal
    closeEvalModal.addEventListener('click', () => evalModal.style.display = 'none');

    // close on outside click & Escape for all modal-bg
    document.querySelectorAll('.modal-bg').forEach(bg => {
      bg.addEventListener('click', (e) => { if (e.target === bg) bg.style.display = 'none'; });
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.querySelectorAll('.modal-bg').forEach(m=>m.style.display='none'); });
  })();

  // ----- Submit new evaluation -----
  submitEval.addEventListener('click', async () => {
    const rows = Array.from(skillsContainer.querySelectorAll('.skill-row'));
    if (rows.length === 0) return alert('No skills to evaluate — select a department or add skills.');

    const skillObj = {};
    let yesCount = 0;
    for (let i=0;i<rows.length;i++){
      const row = rows[i];
      const skillName = row.querySelector('strong').textContent;
      const selected = row.querySelector('input[type="radio"]:checked');
      const notesEl = row.querySelector('textarea');
      if (!selected) return alert('Please rate all skills');
      if (selected.value === 'no' && (!notesEl.value.trim())) return alert('Please enter notes for ❌ items');
      const val = selected.value === 'yes' ? '✔️' : '❌';
      if (val === '✔️') yesCount++;
      skillObj['s' + i] = { name: skillName, value: val, notes: notesEl.value || '' };
    }

    const total = ((yesCount / rows.length) * 100).toFixed(2) + '%';

    const payload = {
      member: evMember.value,
      department: evDept.value,
      date: evDate.value,
      evaluator: evEvaluator.value,
      callId: evCallId.value,
      summary: evSummary.value,
      skills: skillObj,
      total,
      feedback: evNotes.value,
      createdAt: new Date()
    };

    await addEvaluation(payload);
    alert('Saved');
    evalModal.style.display = 'none';
    await loadEvaluations();
  });

  // ----- View / Edit / Delete functions -----
  window.viewEval = function(id) {
    const list = window._allEvaluations || [];
    const docData = list.find(x => x.id === id);
    if (!docData) return alert('Evaluation not found');

    let html = `
      <p><strong>Date:</strong> ${docData.date || ''}</p>
      <p><strong>Member:</strong> ${docData.member || ''}</p>
      <p><strong>Department:</strong> ${docData.department || ''}</p>
      <p><strong>Evaluator:</strong> ${docData.evaluator || ''}</p>
      <p><strong>Call ID:</strong> ${docData.callId || ''}</p>
      <p><strong>Summary:</strong> ${docData.summary || ''}</p>
      <p><strong>Feedback:</strong> ${docData.feedback || ''}</p>
      <p><strong>Total:</strong> ${docData.total || ''}</p>
      <hr/><h4>Skills</h4>
    `;
    const skills = docData.skills || {};
    Object.keys(skills).forEach(k => {
      const s = skills[k];
      html += `<p><strong>${s.name || k}</strong>: ${s.value} ${s.value==='❌' && s.notes?`<br/><em>Note: ${s.notes}</em>`:''}</p><hr/>`;
    });

    viewContent.innerHTML = html;
    viewModal.style.display = 'flex';

    openEditFromView.onclick = () => { viewModal.style.display='none'; editEval(id); };
    deleteFromView.onclick = async () => { viewModal.style.display='none'; deleteEval(id); };
  };

  window.editEval = async function(id) {
    const list = window._allEvaluations || [];
    const docData = list.find(x => x.id === id);
    if (!docData) return alert('Not found');

    editId.value = id;
    editDate.value = docData.date || '';
    editDept.value = docData.department || docData.dept || '';
    editMember.value = docData.member || '';
    editEvaluator.value = docData.evaluator || '';
    editCallId.value = docData.callId || '';
    editSummary.value = docData.summary || '';
    editFeedback.value = docData.feedback || '';
    editTotal.value = docData.total || '';

    // build edit skills
    const skillsArr = Object.values(docData.skills || {});
    editSkillsContainer.innerHTML = '';
    skillsArr.forEach((s, i) => {
      const idBase = `edit_skill_${i}`;
      const div = document.createElement('div');
      div.className = 'skill-row';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>${s.name || 'Skill ' + (i+1)}</strong>
          <div>
            <label><input type="radio" name="edit_${i}" value="yes" ${s.value==='✔️'?'checked':''}> ✔️</label>
            <label><input type="radio" name="edit_${i}" value="no" ${s.value==='❌'?'checked':''}> ❌</label>
          </div>
        </div>
        <textarea id="${idBase}_notes" class="notes" style="${s.value==='❌'?'display:block':''}">${s.notes||''}</textarea>
      `;
      editSkillsContainer.appendChild(div);

      div.querySelectorAll('input[type="radio"]').forEach(r => {
        r.addEventListener('change', () => {
          const notesEl = div.querySelector('textarea');
          if (r.value === 'no') notesEl.style.display = 'block'; else { notesEl.style.display='none'; }
          calculateEditTotal();
        });
      });
    });

    calculateEditTotal();
    editModal.style.display = 'flex';
  };

  function calculateEditTotal() {
    const rows = Array.from(editSkillsContainer.querySelectorAll('.skill-row'));
    let yes = 0;
    rows.forEach((row, i) => {
      const selected = row.querySelector(`input[name="edit_${i}"]:checked`);
      if (selected && selected.value === 'yes') yes++;
    });
    editTotal.value = rows.length ? ((yes / rows.length) * 100).toFixed(2) + '%' : '0%';
  }

  saveEditBtn.addEventListener('click', async () => {
    const id = editId.value;
    if (!id) return alert('Missing id');

    const rows = Array.from(editSkillsContainer.querySelectorAll('.skill-row'));
    const skillObj = {};
    let yes = 0;
    rows.forEach((row, i) => {
      const name = row.querySelector('strong').textContent;
      const selected = row.querySelector(`input[name="edit_${i}"]:checked`);
      const notes = row.querySelector('textarea').value || '';
      if (!selected) return alert('Please rate all skills');
      const val = selected.value === 'yes' ? '✔️' : '❌';
      if (val === '✔️') yes++;
      skillObj['s'+i] = { name, value: val, notes };
    });

    const updated = {
      date: editDate.value,
      department: editDept.value,
      member: editMember.value,
      evaluator: editEvaluator.value,
      callId: editCallId.value,
      summary: editSummary.value,
      feedback: editFeedback.value,
      skills: skillObj,
      total: ((yes / rows.length) * 100).toFixed(2) + '%'
    };

    await updateDoc(doc(db, 'evaluations', id), updated);
    alert('Saved');
    editModal.style.display = 'none';
    await loadEvaluations();
  });

  cancelEditBtn.addEventListener('click', () => editModal.style.display = 'none');

  window.deleteEval = async function(id) {
    if (!confirm('Delete this evaluation?')) return;
    await deleteDoc(doc(db, 'evaluations', id));
    alert('Deleted');
    await loadEvaluations();
  };

  // Initialize page
  (async function init() {
    await loadFiltersAndDropdowns();
    const initialSkills = await loadDepartmentSkills(evDept.value || 'Account Manager');
    renderSkillsForContainer(initialSkills, skillsContainer);
    // close handlers for view modal
    closeView.addEventListener('click', () => viewModal.style.display = 'none');

    // click outside closes
    document.querySelectorAll('.modal-bg').forEach(bg => bg.addEventListener('click', (e) => { if (e.target === bg) bg.style.display = 'none'; }));

    // populate current table
    await loadEvaluations();
  })();

</script>
</body>
</html>
